<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ExcelSeeker</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <body>
    <div class="theme-switch">
      <label class="switch">
        <input type="checkbox" id="themeToggle" />
        <span class="slider round"></span>
      </label>
      <span class="theme-label">Dark Mode</span>
    </div>

    <div class="container">
      <header>
        <h1>ExcelSeeker</h1>
        <p>Search through Excel files with ease</p>
      </header>

      <main>
        <div class="upload-section">
          <form id="searchForm" enctype="multipart/form-data">
            <div class="search-type">
              <label>Search Type:</label>
              <div class="radio-group">
                <input
                  type="radio"
                  id="singleFile"
                  name="searchType"
                  value="file"
                  checked
                />
                <label for="singleFile">Single File</label>
                <input
                  type="radio"
                  id="folder"
                  name="searchType"
                  value="folder"
                />
                <label for="folder">Folder</label>
              </div>
            </div>

            <div id="fileInput" class="file-input">
              <label for="file">Choose Excel File (.xls)</label>
              <input type="file" id="file" name="file" accept=".xls" required />
            </div>

            <div id="folderInput" class="file-input hidden">
              <label for="folderPath">Enter Folder Path</label>
              <div class="folder-input-group">
                <input
                  type="text"
                  id="folderPath"
                  name="folderPath"
                  placeholder="/path/to/folder"
                />
                <button
                  type="button"
                  id="selectFolderBtn"
                  onclick="selectFolder()"
                >
                  Browse...
                </button>
              </div>
              <p class="help-text">
                Enter the full path to the folder containing .xls files
              </p>
            </div>

            <div class="search-input">
              <label for="search_text">Search Text</label>
              <input type="text" id="search_text" name="search_text" required />
            </div>

            <button type="submit">Search</button>
          </form>
        </div>

        <div id="loading" class="loading hidden">
          <div class="spinner"></div>
          <p>Searching...</p>
          <p id="progress" class="progress-text"></p>
          <div class="progress-bar-container hidden">
            <div class="progress-bar"></div>
            <div class="progress-text">0%</div>
          </div>
        </div>

        <div id="results" class="results-section">
          <table class="results-table hidden">
            <thead>
              <tr>
                <th>File</th>
                <th>Sheet</th>
                <th>Row</th>
                <th>Column</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
          <div id="noResults" class="no-results hidden">
            <p>No results found</p>
          </div>
          <div id="error" class="error hidden"></div>
        </div>
      </main>
    </div>

    <script>
      // Theme toggle functionality
      const themeToggle = document.getElementById("themeToggle");
      const html = document.documentElement;

      // Check for saved theme preference
      const savedTheme = localStorage.getItem("theme") || "light";
      html.setAttribute("data-theme", savedTheme);
      themeToggle.checked = savedTheme === "dark";

      themeToggle.addEventListener("change", () => {
        const newTheme = themeToggle.checked ? "dark" : "light";
        html.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
      });

      // Toggle between file and folder input
      document.querySelectorAll('input[name="searchType"]').forEach((radio) => {
        radio.addEventListener("change", (e) => {
          const fileInput = document.getElementById("fileInput");
          const folderInput = document.getElementById("folderInput");
          const fileElement = document.getElementById("file");
          const folderElement = document.getElementById("folderPath");

          if (e.target.value === "file") {
            fileInput.classList.remove("hidden");
            folderInput.classList.add("hidden");
            fileElement.required = true;
            folderElement.required = false;
          } else {
            fileInput.classList.add("hidden");
            folderInput.classList.remove("hidden");
            fileElement.required = false;
            folderElement.required = true;
          }
        });
      });

      async function handleFolderSearch(folderPath, searchText) {
        const loading = document.getElementById("loading");
        const progress = document.getElementById("progress");
        const progressBar = loading.querySelector(".progress-bar");
        const progressBarContainer = loading.querySelector(
          ".progress-bar-container"
        );
        const progressText = loading.querySelector(".progress-text");
        let eventSource = null;

        // Show loading and progress bar
        loading.classList.remove("hidden");
        progressBarContainer.classList.remove("hidden");

        try {
          // Clean up any existing connection
          if (eventSource) {
            eventSource.close();
          }

          const url = new URL("/search_folder", window.location.origin);
          url.searchParams.append("folder_path", folderPath);
          url.searchParams.append("search_text", searchText);

          eventSource = new EventSource(url.toString());

          eventSource.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);

              if (data.type === "progress") {
                const percent = Math.round((data.processed / data.total) * 100);
                progressBar.style.width = `${percent}%`;
                progressText.textContent = `${percent}%`;
                progress.textContent = `Processing: ${data.current_file} (${data.processed}/${data.total} files, ${data.found_results} results found)`;
              } else if (data.type === "complete") {
                eventSource.close();
                displayResults(data.results);
                loading.classList.add("hidden");
                progressBarContainer.classList.add("hidden");
              }
            } catch (error) {
              console.error("Error parsing SSE data:", error);
              throw new Error("Error processing folder data");
            }
          };

          eventSource.onerror = (error) => {
            console.error("SSE Error:", error);
            eventSource.close();
            throw new Error("Error processing folder: Connection failed");
          };

          // Add cleanup on page unload
          window.addEventListener("beforeunload", () => {
            if (eventSource) {
              eventSource.close();
            }
          });
        } catch (error) {
          console.error("Error:", error);
          const errorDiv = document.getElementById("error");
          errorDiv.textContent = error.message || "Failed to process folder";
          errorDiv.classList.remove("hidden");
          loading.classList.add("hidden");
          progressBarContainer.classList.add("hidden");

          // Clean up connection on error
          if (eventSource) {
            eventSource.close();
          }
        }
      }

      // Update the form submit handler
      document
        .getElementById("searchForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const form = e.target;
          const formData = new FormData(form);
          const loading = document.getElementById("loading");
          const progress = document.getElementById("progress");
          const resultsTable = document.querySelector(".results-table");
          const resultsBody = document.getElementById("resultsBody");
          const noResults = document.getElementById("noResults");
          const error = document.getElementById("error");
          const searchType = formData.get("searchType");

          // Reset and show loading
          loading.classList.remove("hidden");
          resultsTable.classList.add("hidden");
          noResults.classList.add("hidden");
          error.classList.add("hidden");

          try {
            if (searchType === "folder") {
              const folderPath = formData.get("folderPath");
              await handleFolderSearch(folderPath, formData.get("search_text"));
            } else {
              const response = await fetch("/search", {
                method: "POST",
                body: formData,
              });

              const data = await response.json();

              if (!response.ok) {
                throw new Error(data.error || "An error occurred");
              }

              if (data.error) {
                throw new Error(data.error);
              }

              const filename = formData.get("file").name;
              const results = Array.isArray(data)
                ? data.map((result) => ({
                    ...result,
                    filename,
                  }))
                : [];

              displayResults(results);
            }
          } catch (err) {
            error.textContent = err.message;
            error.classList.remove("hidden");
          } finally {
            if (searchType !== "folder") {
              loading.classList.add("hidden");
              progress.textContent = "";
            }
          }
        });

      function displayResults(results) {
        const resultsTable = document.querySelector(".results-table");
        const resultsBody = document.getElementById("resultsBody");
        const noResults = document.getElementById("noResults");

        resultsBody.innerHTML = "";

        if (results.length === 0) {
          noResults.classList.remove("hidden");
          resultsTable.classList.add("hidden");
        } else {
          results.forEach((result) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                        <td>${result.filename}</td>
                        <td>${result.sheet}</td>
                        <td>${result.row}</td>
                        <td>${result.column}</td>
                        <td>${result.value}</td>
                    `;
            resultsBody.appendChild(row);
          });
          resultsTable.classList.remove("hidden");
          noResults.classList.add("hidden");
        }
      }

      // Add this function for folder selection
      async function selectFolder() {
        try {
          const response = await fetch("http://localhost:3000/select-folder", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const data = await response.json();
          if (data.path) {
            document.getElementById("folderPath").value = data.path;
          }
        } catch (error) {
          console.error("Error selecting folder:", error);
          // Show error in the UI
          const errorDiv = document.getElementById("error");
          errorDiv.textContent =
            "Failed to open folder selection dialog. Make sure the folder service is running.";
          errorDiv.classList.remove("hidden");
        }
      }
    </script>
  </body>
</html>
