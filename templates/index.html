<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ExcelSeeker</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <body>
    <div class="theme-switch">
      <label class="switch">
        <input type="checkbox" id="themeToggle" />
        <span class="slider round"></span>
      </label>
      <span class="theme-label">Dark Mode</span>
    </div>

    <div class="container">
      <header>
        <h1>ExcelSeeker</h1>
        <p>Search through Excel files with ease</p>
      </header>

      <main>
        <div class="upload-section">
          <form id="searchForm" enctype="multipart/form-data">
            <div class="search-type">
              <label>Search Type:</label>
              <div class="radio-group">
                <input
                  type="radio"
                  id="singleFile"
                  name="searchType"
                  value="file"
                  checked
                />
                <label for="singleFile">Single File</label>
                <input
                  type="radio"
                  id="folder"
                  name="searchType"
                  value="folder"
                />
                <label for="folder">Folder</label>
              </div>
            </div>

            <div id="fileInput" class="file-input">
              <label for="file">Choose Excel File (.xls)</label>
              <input type="file" id="file" name="file" accept=".xls" required />
            </div>

            <div id="folderInput" class="file-input hidden">
              <label for="folderPath">Enter Folder Path</label>
              <input
                type="text"
                id="folderPath"
                name="folderPath"
                placeholder="/path/to/folder"
              />
              <p class="help-text">
                Enter the full path to the folder containing .xls files
              </p>
            </div>

            <div class="search-input">
              <label for="search_text">Search Text</label>
              <input type="text" id="search_text" name="search_text" required />
            </div>

            <button type="submit">Search</button>
          </form>
        </div>

        <div id="loading" class="loading hidden">
          <div class="spinner"></div>
          <p>Searching...</p>
          <p id="progress" class="progress-text"></p>
        </div>

        <div id="results" class="results-section">
          <table class="results-table hidden">
            <thead>
              <tr>
                <th>File</th>
                <th>Sheet</th>
                <th>Row</th>
                <th>Column</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
          <div id="noResults" class="no-results hidden">
            <p>No results found</p>
          </div>
          <div id="error" class="error hidden"></div>
        </div>
      </main>
    </div>

    <script>
      // Theme toggle functionality
      const themeToggle = document.getElementById("themeToggle");
      const html = document.documentElement;

      // Check for saved theme preference
      const savedTheme = localStorage.getItem("theme") || "light";
      html.setAttribute("data-theme", savedTheme);
      themeToggle.checked = savedTheme === "dark";

      themeToggle.addEventListener("change", () => {
        const newTheme = themeToggle.checked ? "dark" : "light";
        html.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
      });

      // Toggle between file and folder input
      document.querySelectorAll('input[name="searchType"]').forEach((radio) => {
        radio.addEventListener("change", (e) => {
          const fileInput = document.getElementById("fileInput");
          const folderInput = document.getElementById("folderInput");
          const fileElement = document.getElementById("file");
          const folderElement = document.getElementById("folderPath");

          if (e.target.value === "file") {
            fileInput.classList.remove("hidden");
            folderInput.classList.add("hidden");
            fileElement.required = true;
            folderElement.required = false;
          } else {
            fileInput.classList.add("hidden");
            folderInput.classList.remove("hidden");
            fileElement.required = false;
            folderElement.required = true;
          }
        });
      });

      document
        .getElementById("searchForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const form = e.target;
          const formData = new FormData(form);
          const loading = document.getElementById("loading");
          const progress = document.getElementById("progress");
          const resultsTable = document.querySelector(".results-table");
          const resultsBody = document.getElementById("resultsBody");
          const noResults = document.getElementById("noResults");
          const error = document.getElementById("error");
          const searchType = formData.get("searchType");

          // Reset and show loading
          loading.classList.remove("hidden");
          resultsTable.classList.add("hidden");
          noResults.classList.add("hidden");
          error.classList.add("hidden");

          try {
            if (searchType === "folder") {
              const folderPath = formData.get("folderPath");
              const response = await fetch("/search_folder", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  folder_path: folderPath,
                  search_text: formData.get("search_text"),
                }),
              });

              const data = await response.json();

              if (!response.ok) {
                throw new Error(data.error || "An error occurred");
              }

              displayResults(data);
            } else {
              const response = await fetch("/search", {
                method: "POST",
                body: formData,
              });

              const data = await response.json();

              if (!response.ok) {
                throw new Error(data.error || "An error occurred");
              }

              if (data.error) {
                throw new Error(data.error);
              }

              const filename = formData.get("file").name;
              const results = Array.isArray(data)
                ? data.map((result) => ({
                    ...result,
                    filename,
                  }))
                : [];

              displayResults(results);
            }
          } catch (err) {
            error.textContent = err.message;
            error.classList.remove("hidden");
          } finally {
            loading.classList.add("hidden");
            progress.textContent = "";
          }
        });

      function displayResults(results) {
        const resultsTable = document.querySelector(".results-table");
        const resultsBody = document.getElementById("resultsBody");
        const noResults = document.getElementById("noResults");

        resultsBody.innerHTML = "";

        if (results.length === 0) {
          noResults.classList.remove("hidden");
          resultsTable.classList.add("hidden");
        } else {
          results.forEach((result) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                        <td>${result.filename}</td>
                        <td>${result.sheet}</td>
                        <td>${result.row}</td>
                        <td>${result.column}</td>
                        <td>${result.value}</td>
                    `;
            resultsBody.appendChild(row);
          });
          resultsTable.classList.remove("hidden");
          noResults.classList.add("hidden");
        }
      }
    </script>
  </body>
</html>
